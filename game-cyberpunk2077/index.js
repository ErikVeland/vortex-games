const { isWindows } = require('vortex-api');
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const bluebird_1 = __importDefault(require("bluebird"));
const path_1 = __importDefault(require("path"));
const vortex_api_1 = require("vortex-api");
const GAME_ID = 'cyberpunk2077';
const STEAM_ID = '1091500';
const GOG_ID = '1423049311';
const EPIC_ID = '77f2b98e2cfd40c8a7e58ab7b1b8a6b2';
const REQUIRED_FILES = [];
const ALTERNATIVE_FILES = [
    'Cyberpunk2077.exe',
    'bin/Cyberpunk2077.exe',
    'engine/config/platform/pc/engine.ini',
];
function findGame() {
    return vortex_api_1.util.GameStoreHelper.findByAppId([STEAM_ID, GOG_ID, EPIC_ID])
        .then(game => {
        (0, vortex_api_1.log)('debug', 'Found Cyberpunk 2077 via game store', { path: game.gamePath });
        return game.gamePath;
    })
        .catch(() => {
        (0, vortex_api_1.log)('debug', 'Game store detection failed, trying manual paths');
        const commonPaths = [
            '/Applications/Cyberpunk 2077.app/Contents/Resources',
            '/Applications/Games/Cyberpunk 2077.app/Contents/Resources',
            path_1.default.join(process.env.HOME || '', 'Library/Application Support/CrossOver/Bottles/Steam/drive_c/Program Files (x86)/Steam/steamapps/common/Cyberpunk 2077'),
            path_1.default.join(process.env.HOME || '', 'Games/Cyberpunk 2077'),
            path_1.default.join(process.env.HOME || '', 'Library/Application Support/Steam/steamapps/common/Cyberpunk 2077'),
        ];
        return bluebird_1.default.mapSeries(commonPaths, (gamePath) => {
            return vortex_api_1.fs.statAsync(gamePath)
                .then(() => {
                (0, vortex_api_1.log)('debug', 'Found potential Cyberpunk 2077 path', { path: gamePath });
                return gamePath;
            })
                .catch(() => {
                (0, vortex_api_1.log)('debug', 'Path not found', { path: gamePath });
                return undefined;
            });
        }).then((results) => {
            const validPath = results.find(path => path !== undefined);
            if (validPath) {
                (0, vortex_api_1.log)('info', 'Cyberpunk 2077 found at', { path: validPath });
                return validPath;
            }
            (0, vortex_api_1.log)('warn', 'Cyberpunk 2077 not found in any common locations');
            throw new Error('Cyberpunk 2077 not found');
        });
    });
}
function testSupportedContent(files, gameId) {
    const supported = files.find(file => path_1.default.extname(file).toLowerCase() === '.archive' ||
        path_1.default.extname(file).toLowerCase() === '.xl' ||
        file.toLowerCase().includes('cyberpunk') ||
        file.toLowerCase().includes('redmod')) !== undefined;
    return bluebird_1.default.resolve({
        supported,
        requiredFiles: [],
    });
}
function installContent(files) {
    const instructions = files.map(file => ({
        type: 'copy',
        source: file,
        destination: file,
    }));
    return bluebird_1.default.resolve({ instructions });
}
function prepareForModding(discovery) {
    const modPath = path_1.default.join(discovery.path, 'archive', 'pc', 'mod');
    return vortex_api_1.fs.ensureDirWritableAsync(modPath);
}
function main(context) {
    context.registerGame({
        id: GAME_ID,
        name: 'Cyberpunk 2077',
        mergeMods: false,
        queryPath: findGame,
        supportedTools: [],
        queryModPath: () => 'archive/pc/mod',
        logo: 'gameart.jpg',
        executable: (discoveredPath) => {
            if (process.platform === 'darwin') {
                if (discoveredPath && discoveredPath.includes('steamapps')) {
                    return 'Cyberpunk2077.app/Contents/MacOS/Cyberpunk2077';
                }
                return 'Cyberpunk2077';
            }
            if (!discoveredPath || typeof discoveredPath !== 'string' || discoveredPath.trim() === '') {
                return 'bin/x64/Cyberpunk2077.exe';
            }
            const possibleExecutables = [
                'bin/x64/Cyberpunk2077.exe',
                'Cyberpunk2077.exe',
                'bin/Cyberpunk2077.exe',
            ];
            for (const exe of possibleExecutables) {
                const fullPath = path_1.default.join(discoveredPath, exe);
                try {
                    if (vortex_api_1.fs.statSync(fullPath).isFile()) {
                        return exe;
                    }
                }
                catch (err) {
                }
            }
            return 'bin/x64/Cyberpunk2077.exe';
        },
        requiredFiles: REQUIRED_FILES,
        setup: prepareForModding,
        environment: {
            SteamAPPId: STEAM_ID,
        },
        details: {
            steamAppId: parseInt(STEAM_ID, 10),
            gogAppId: GOG_ID,
            epicAppId: EPIC_ID,
        },
    });
    context.registerInstaller('cyberpunk2077-mod', 25, testSupportedContent, installContent);
    return true;
}
exports.default = main;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLHdEQUFnQztBQUNoQyxnREFBd0I7QUFDeEIsMkNBQXNFO0FBRXRFLE1BQU0sT0FBTyxHQUFHLGVBQWUsQ0FBQztBQUNoQyxNQUFNLFFBQVEsR0FBRyxTQUFTLENBQUM7QUFDM0IsTUFBTSxNQUFNLEdBQUcsWUFBWSxDQUFDO0FBQzVCLE1BQU0sT0FBTyxHQUFHLGtDQUFrQyxDQUFDO0FBSW5ELE1BQU0sY0FBYyxHQUFhLEVBQUUsQ0FBQztBQUdwQyxNQUFNLGlCQUFpQixHQUFHO0lBQ3hCLG1CQUFtQjtJQUNuQix1QkFBdUI7SUFDdkIsc0NBQXNDO0NBQ3ZDLENBQUM7QUFFRixTQUFTLFFBQVE7SUFFZixPQUFPLGlCQUFJLENBQUMsZUFBZSxDQUFDLFdBQVcsQ0FBQyxDQUFDLFFBQVEsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7U0FDakUsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFO1FBQ1gsSUFBQSxnQkFBRyxFQUFDLE9BQU8sRUFBRSxxQ0FBcUMsRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztRQUM3RSxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUM7SUFDdkIsQ0FBQyxDQUFDO1NBQ0QsS0FBSyxDQUFDLEdBQUcsRUFBRTtRQUNWLElBQUEsZ0JBQUcsRUFBQyxPQUFPLEVBQUUsa0RBQWtELENBQUMsQ0FBQztRQUdqRSxNQUFNLFdBQVcsR0FBRztZQUVsQixxREFBcUQ7WUFDckQsMkRBQTJEO1lBRTNELGNBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksRUFBRSxFQUFFLHVIQUF1SCxDQUFDO1lBRTFKLGNBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksRUFBRSxFQUFFLHNCQUFzQixD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QUNyQjtRQUNELE9BQU8sRUFBRTtZQUNQLFVBQVUsRUFBRSxRQUFRLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQztZQUNsQyxRQUFRLEVBQUUsTUFBTTtZQUNoQixTQUFTLEVBQUUsT0FBTztTQUNuQjtLQUNGLENBQUMsQ0FBQztJQUVILE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxtQkFBbUIsRUFBRSxFQUFFLEVBQUUsb0JBQW9CLEVBQUUsY0FBYyxDQUFDLENBQUM7SUFFekYsT0FBTyxJQUFJLENBQUM7QUFDZCxDQUFDO0FBRUQsa0JBQWUsSUFBSSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEJsdWViaXJkIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgYWN0aW9ucywgZnMsIGxvZywgc2VsZWN0b3JzLCB0eXBlcywgdXRpbCB9IGZyb20gJ3ZvcnRleC1hcGknO1xuXG5jb25zdCBHQU1FX0lEID0gJ2N5YmVycHVuazIwNzcnO1xuY29uc3QgU1RFQU1fSUQgPSAnMTA5MTUwMCc7XG5jb25zdCBHT0dfSUQgPSAnMTQyMzA0OTMxMSc7XG5jb25zdCBFUElDX0lEID0gJzc3ZjJiOThlMmNmZDQwYzhhN2U1OGFiN2IxYjhhNmIyJztcblxuLy8gVXNlIGVtcHR5IHJlcXVpcmVkIGZpbGVzIHRvIGF2b2lkIHZhbGlkYXRpb24gaXNzdWVzIHdpdGggQ3Jvc3NPdmVyL1dpbmUgaW5zdGFsbGF0aW9uc1xuLy8gVGhlIGdhbWUgZGV0ZWN0aW9uIHdpbGwgYmUgaGFuZGxlZCBieSB0aGUgcXVlcnlQYXRoIGZ1bmN0aW9uIGluc3RlYWRcbmNvbnN0IFJFUVVJUkVEX0ZJTEVTOiBzdHJpbmdbXSA9IFtdO1xuXG4vLyBBbHRlcm5hdGl2ZSBmaWxlcyBmb3IgZGlmZmVyZW50IGluc3RhbGxhdGlvbiB0eXBlc1xuY29uc3QgQUxURVJOQVRJVkVfRklMRVMgPSBbXG4gICdDeWJlcnB1bmsyMDc3LmV4ZScsIC8vIFNvbWV0aW1lcyBpbiByb290XG4gICdiaW4vQ3liZXJwdW5rMjA3Ny5leGUnLCAvLyBBbHRlcm5hdGl2ZSBsb2NhdGlvblxuICAnZW5naW5lL2NvbmZpZy9wbGF0Zm9ybS9wYy9lbmdpbmUuaW5pJywgLy8gQWx0ZXJuYXRpdmUgY29uZmlnIGxvY2F0aW9uXG5dO1xuXG5mdW5jdGlvbiBmaW5kR2FtZSgpOiBCbHVlYmlyZDxzdHJpbmc+IHtcbiAgLy8gVHJ5IHRvIGZpbmQgdmlhIGdhbWUgc3RvcmVzIGZpcnN0XG4gIHJldHVybiB1dGlsLkdhbWVTdG9yZUhlbHBlci5maW5kQnlBcHBJZChbU1RFQU1fSUQsIEdPR19JRCwgRVBJQ19JRF0pXG4gICAgLnRoZW4oZ2FtZSA9PiB7XG4gICAgICBsb2coJ2RlYnVnJywgJ0ZvdW5kIEN5YmVycHVuayAyMDc3IHZpYSBnYW1lIHN0b3JlJywgeyBwYXRoOiBnYW1lLmdhbWVQYXRoIH0pO1xuICAgICAgcmV0dXJuIGdhbWUuZ2FtZVBhdGg7XG4gICAgfSlcbiAgICAuY2F0Y2goKCkgPT4ge1xuICAgICAgbG9nKCdkZWJ1ZycsICdHYW1lIHN0b3JlIGRldGVjdGlvbiBmYWlsZWQsIHRyeWluZyBtYW51YWwgcGF0aHMnKTtcbiAgICAgIFxuICAgICAgLy8gSWYgbm90IGZvdW5kIHZpYSBzdG9yZXMsIHRyeSBjb21tb24gbWFjT1MgbG9jYXRpb25zXG4gICAgICBjb25zdCBjb21tb25QYXRocyA9IFtcbiAgICAgICAgLy8gTmF0aXZlIG1hY09TIGxvY2F0aW9uc1xuICAgICAgICAnL0FwcGxpY2F0aW9ucy9DeWJlcnB1bmsgMjA3Ny5hcHAvQ29udGVudHMvUmVzb3VyY2VzJyxcbiAgICAgICAgJy9BcHBsaWNhdGlvbnMvR2FtZXMvQ3liZXJwdW5rIDIwNzcuYXBwL0NvbnRlbnRzL1Jlc291cmNlcycsXG4gICAgICAgIC8vIENyb3NzT3Zlci9XaW5lIGxvY2F0aW9ucyAtIHVzZSB0aGUgYWN0dWFsIHBhdGggd2UgZm91bmRcbiAgICAgICAgcGF0aC5qb2luKHByb2Nlc3MuZW52LkhPTUUgfHwgJycsICdMaWJyYXJ5L0FwcGxpY2F0aW9uIFN1cHBvcnQvQ3Jvc3NPdmVyL0JvdHRsZXMvU3RlYW0vZHJpdmVfYy9Qcm9ncmFtIEZpbGVzICh4ODYpL1N0ZWFtL3N0ZWFtYXBwcy9jb21tb24vQ3liZXJwdW5rIDIwNzcnKSxcbiAgICAgICAgLy8gT3RoZXIgcG90ZW50aWFsIGxvY2F0aW9uc1xuICAgICAgICBwYXRoLmpvaW4ocHJvY2Vzcy5lbnYuSE9NRSB8fCAnJywgJ0dhbWVzL0N5YmVycHVuayAyMDc3JyksXG4gICAgICAgIHBhdGguam9pbihwcm9jZXNzLmVudi5IT01FIHx8ICcnLCAnTGlicmFyeS9BcHBsaWNhdGlvbiBTdXBwb3J0L1N0ZWFtL3N0ZWFtYXBwcy9jb21tb24vQ3liZXJwdW5rIDIwNzcnKSxcbiAgICAgIF07XG5cbiAgICAgIHJldHVybiBCbHVlYmlyZC5tYXBTZXJpZXMoY29tbW9uUGF0aHMsIChnYW1lUGF0aCkgPT4ge1xuICAgICAgICByZXR1cm4gZnMuc3RhdEFzeW5jKGdhbWVQYXRoKVxuICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIGxvZygnZGVidWcnLCAnRm91bmQgcG90ZW50aWFsIEN5YmVycHVuayAyMDc3IHBhdGgnLCB7IHBhdGg6IGdhbWVQYXRoIH0pO1xuICAgICAgICAgICAgcmV0dXJuIGdhbWVQYXRoO1xuICAgICAgICAgIH0pXG4gICAgICAgICAgLmNhdGNoKCgpID0+IHtcbiAgICAgICAgICAgIGxvZygnZGVidWcnLCAnUGF0aCBub3QgZm91bmQnLCB7IHBhdGg6IGdhbWVQYXRoIH0pO1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgICB9KTtcbiAgICAgIH0pLnRoZW4oKHJlc3VsdHMpID0+IHtcbiAgICAgICAgY29uc3QgdmFsaWRQYXRoID0gcmVzdWx0cy5maW5kKHBhdGggPT4gcGF0aCAhPT0gdW5kZWZpbmVkKTtcbiAgICAgICAgaWYgKHZhbGlkUGF0aCkge1xuICAgICAgICAgIGxvZygnaW5mbycsICdDeWJlcnB1bmsgMjA3NyBmb3VuZCBhdCcsIHsgcGF0aDogdmFsaWRQYXRoIH0pO1xuICAgICAgICAgIHJldHVybiB2YWxpZFBhdGg7XG4gICAgICAgIH1cbiAgICAgICAgbG9nKCd3YXJuJywgJ0N5YmVycHVuayAyMDc3IG5vdCBmb3VuZCBpbiBhbnkgY29tbW9uIGxvY2F0aW9ucycpO1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0N5YmVycHVuayAyMDc3IG5vdCBmb3VuZCcpO1xuICAgICAgfSk7XG4gICAgfSk7XG59XG5cbmZ1bmN0aW9uIHRlc3RTdXBwb3J0ZWRDb250ZW50KGZpbGVzOiBzdHJpbmdbXSwgZ2FtZUlkOiBzdHJpbmcpOiBCbHVlYmlyZDx0eXBlcy5JU3VwcG9ydGVkUmVzdWx0PiB7XG4gIC8vIEJhc2ljIG1vZCBzdXBwb3J0IC0gbW9zdCBDeWJlcnB1bmsgbW9kcyBhcmUgc2ltcGxlIGZpbGUgcmVwbGFjZW1lbnRzXG4gIGNvbnN0IHN1cHBvcnRlZCA9IGZpbGVzLmZpbmQoZmlsZSA9PiBcbiAgICBwYXRoLmV4dG5hbWUoZmlsZSkudG9Mb3dlckNhc2UoKSA9PT0gJy5hcmNoaXZlJyB8fFxuICAgIHBhdGguZXh0bmFtZShmaWxlKS50b0xvd2VyQ2FzZSgpID09PSAnLnhsJyB8fFxuICAgIGZpbGUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnY3liZXJwdW5rJykgfHxcbiAgICBmaWxlLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoJ3JlZG1vZCcpXG4gICkgIT09IHVuZGVmaW5lZDtcblxuICByZXR1cm4gQmx1ZWJpcmQucmVzb2x2ZSh7XG4gICAgc3VwcG9ydGVkLFxuICAgIHJlcXVpcmVkRmlsZXM6IFtdLFxuICB9KTtcbn1cblxuZnVuY3Rpb24gaW5zdGFsbENvbnRlbnQoZmlsZXM6IHN0cmluZ1tdKTogQmx1ZWJpcmQ8dHlwZXMuSUluc3RhbGxSZXN1bHQ+IHtcbiAgLy8gU2ltcGxlIGluc3RhbGxhdGlvbiAtIGNvcHkgZmlsZXMgdG8gbW9kIGRpcmVjdG9yeVxuICBjb25zdCBpbnN0cnVjdGlvbnM6IHR5cGVzLklJbnN0cnVjdGlvbltdID0gZmlsZXMubWFwKGZpbGUgPT4gKHtcbiAgICB0eXBlOiAnY29weScsXG4gICAgc291cmNlOiBmaWxlLFxuICAgIGRlc3RpbmF0aW9uOiBmaWxlLFxuICB9KSk7XG5cbiAgcmV0dXJuIEJsdWViaXJkLnJlc29sdmUoeyBpbnN0cnVjdGlvbnMgfSk7XG59XG5cbmZ1bmN0aW9uIHByZXBhcmVGb3JNb2RkaW5nKGRpc2NvdmVyeTogdHlwZXMuSURpc2NvdmVyeVJlc3VsdCk6IEJsdWViaXJkPHZvaWQ+IHtcbiAgLy8gRW5zdXJlIG1vZCBkaXJlY3RvcmllcyBleGlzdFxuICBjb25zdCBtb2RQYXRoID0gcGF0aC5qb2luKGRpc2NvdmVyeS5wYXRoLCAnYXJjaGl2ZScsICdwYycsICdtb2QnKTtcbiAgcmV0dXJuIGZzLmVuc3VyZURpcldyaXRhYmxlQXN5bmMobW9kUGF0aCk7XG59XG5cbmZ1bmN0aW9uIG1haW4oY29udGV4dDogdHlwZXMuSUV4dGVuc2lvbkNvbnRleHQpIHtcbiAgY29udGV4dC5yZWdpc3RlckdhbWUoe1xuICAgIGlkOiBHQU1FX0lELFxuICAgIG5hbWU6ICdDeWJlcnB1bmsgMjA3NycsXG4gICAgbWVyZ2VNb2RzOiBmYWxzZSxcbiAgICBxdWVyeVBhdGg6IGZpbmRHYW1lLFxuICAgIHN1cHBvcnRlZFRvb2xzOiBbXSxcbiAgICBxdWVyeU1vZFBhdGg6ICgpID0+ICdhcmNoaXZlL3BjL21vZCcsXG4gICAgbG9nbzogJ2dhbWVhcnQuanBnJyxcbiAgICBleGVjdXRhYmxlOiAoZGlzY292ZXJlZFBhdGg6IHN0cmluZykgPT4ge1xuICAgICAgLy8gSGFuZGxlIG1hY09TIGFwcCBidW5kbGUgc3RydWN0dXJlXG4gICAgICBpZiAocHJvY2Vzcy5wbGF0Zm9ybSA9PT0gJ2RhcndpbicpIHtcbiAgICAgICAgLy8gRm9yIFN0ZWFtIGluc3RhbGxhdGlvbnMsIHRoZSBkaXNjb3ZlcmVkUGF0aCBwb2ludHMgdG8gdGhlIGZvbGRlciBjb250YWluaW5nIHRoZSAuYXBwIGJ1bmRsZVxuICAgICAgICAvLyBXZSBuZWVkIHRvIHJldHVybiB0aGUgcGF0aCB0byB0aGUgZXhlY3V0YWJsZSBpbnNpZGUgdGhlIGFwcCBidW5kbGVcbiAgICAgICAgaWYgKGRpc2NvdmVyZWRQYXRoICYmIGRpc2NvdmVyZWRQYXRoLmluY2x1ZGVzKCdzdGVhbWFwcHMnKSkge1xuICAgICAgICAgIHJldHVybiAnQ3liZXJwdW5rMjA3Ny5hcHAvQ29udGVudHMvTWFjT1MvQ3liZXJwdW5rMjA3Nyc7XG4gICAgICAgIH1cbiAgICAgICAgLy8gRm9yIG5hdGl2ZSBtYWNPUyBpbnN0YWxsYXRpb25zLCB0aGUgZGlzY292ZXJlZFBhdGggYWxyZWFkeSBwb2ludHMgdG8gQ29udGVudHMvUmVzb3VyY2VzXG4gICAgICAgIHJldHVybiAnQ3liZXJwdW5rMjA3Nyc7XG4gICAgICB9XG5cbiAgICAgIC8vIENoZWNrIGlmIGRpc2NvdmVyZWRQYXRoIGlzIHZhbGlkIC0gaGFuZGxlIHVuZGVmaW5lZCwgbnVsbCwgZW1wdHkgc3RyaW5nXG4gICAgICBpZiAoIWRpc2NvdmVyZWRQYXRoIHx8IHR5cGVvZiBkaXNjb3ZlcmVkUGF0aCAhPT0gJ3N0cmluZycgfHwgZGlzY292ZXJlZFBhdGgudHJpbSgpID09PSAnJykge1xuICAgICAgICByZXR1cm4gJ2Jpbi94NjQvQ3liZXJwdW5rMjA3Ny5leGUnO1xuICAgICAgfVxuXG4gICAgICAvLyBUcnkgdG8gZmluZCB0aGUgZXhlY3V0YWJsZSBpbiB2YXJpb3VzIGxvY2F0aW9ucyBmb3IgV2luZG93c1xuICAgICAgY29uc3QgcG9zc2libGVFeGVjdXRhYmxlcyA9IFtcbiAgICAgICAgJ2Jpbi94NjQvQ3liZXJwdW5rMjA3Ny5leGUnLFxuICAgICAgICAnQ3liZXJwdW5rMjA3Ny5leGUnLFxuICAgICAgICAnYmluL0N5YmVycHVuazIwNzcuZXhlJyxcbiAgICAgIF07XG5cbiAgICAgIGZvciAoY29uc3QgZXhlIG9mIHBvc3NpYmxlRXhlY3V0YWJsZXMpIHtcbiAgICAgICAgY29uc3QgZnVsbFBhdGggPSBwYXRoLmpvaW4oZGlzY292ZXJlZFBhdGgsIGV4ZSk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgaWYgKGZzLnN0YXRTeW5jKGZ1bGxQYXRoKS5pc0ZpbGUoKSkge1xuICAgICAgICAgICAgcmV0dXJuIGV4ZTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgIC8vIENvbnRpbnVlIHRvIG5leHQgcG9zc2liaWxpdHlcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgXG4gICAgICAvLyBEZWZhdWx0IGZhbGxiYWNrIGZvciBXaW5kb3dzXG4gICAgICByZXR1cm4gJ2Jpbi94NjQvQ3liZXJwdW5rMjA3Ny5leGUnO1xuICAgIH0sXG4gICAgcmVxdWlyZWRGaWxlczogUkVRVUlSRURfRklMRVMsXG4gICAgc2V0dXA6IHByZXBhcmVGb3JNb2RkaW5nLFxuICAgIGVudmlyb25tZW50OiB7XG4gICAgICBTdGVhbUFQUElkOiBTVEVBTV9JRCxcbiAgICB9LFxuICAgIGRldGFpbHM6IHtcbiAgICAgIHN0ZWFtQXBwSWQ6IHBhcnNlSW50KFNURUFNX0lELCAxMCksXG4gICAgICBnb2dBcHBJZDogR09HX0lELFxuICAgICAgZXBpY0FwcElkOiBFUElDX0lELFxuICAgIH0sXG4gIH0pO1xuXG4gIGNvbnRleHQucmVnaXN0ZXJJbnN0YWxsZXIoJ2N5YmVycHVuazIwNzctbW9kJywgMjUsIHRlc3RTdXBwb3J0ZWRDb250ZW50LCBpbnN0YWxsQ29udGVudCk7XG5cbiAgcmV0dXJuIHRydWU7XG59XG5cbmV4cG9ydCBkZWZhdWx0IG1haW47Il19