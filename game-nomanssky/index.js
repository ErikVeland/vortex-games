"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const path_1 = __importDefault(require("path"));
const semver_1 = __importDefault(require("semver"));
const vortex_api_1 = require("vortex-api");
const GAME_ID = 'nomanssky';
const STEAMAPP_ID = '275850';
const XBOX_ID = 'HelloGames.NoMansSky';
const MODTYPE_DEPRECATED_PAK = 'nomanssky-deprecated-pak';
function purge(api) {
    return __awaiter(this, void 0, void 0, function* () {
        return new Promise((resolve, reject) => api.events.emit('purge-mods', true, (err) => err ? reject(err) : resolve()));
    });
}
function deploy(api) {
    return __awaiter(this, void 0, void 0, function* () {
        return new Promise((resolve, reject) => api.events.emit('deploy-mods', (err) => err ? reject(err) : resolve()));
    });
}
function findGame() {
    return vortex_api_1.util.GameStoreHelper.findByAppId([STEAMAPP_ID, XBOX_ID])
        .then(game => game.gamePath);
}
function deprecatedModPath() {
    return path_1.default.join('GAMEDATA', 'PCBANKS', 'MODS');
}
function modPath() {
    return path_1.default.join('GAMEDATA', 'MODS');
}
function migrate101(api, oldVersion) {
    return __awaiter(this, void 0, void 0, function* () {
        if (semver_1.default.gte(oldVersion, '1.0.1')) {
            return Promise.resolve();
        }
        const state = api.getState();
        const mods = vortex_api_1.util.getSafe(state, ['persistent', 'mods', GAME_ID], {});
        const modIds = Object.keys(mods).filter(modId => mods[modId].type !== 'nomanssky-deprecated-pak');
        const batched = modIds.map(modId => vortex_api_1.actions.setModType(GAME_ID, modId, MODTYPE_DEPRECATED_PAK));
        if (batched.length > 0) {
            try {
                (0, vortex_api_1.log)('info', 'Migrating mods to deprecated PAK type.', { mods: batched.length });
                yield api.awaitUI();
                yield purge(api);
                vortex_api_1.util.batchDispatch(api.store, batched);
                yield new Promise(resolve => setTimeout(resolve, 1000));
                yield deploy(api);
            }
            catch (err) {
                (0, vortex_api_1.log)('error', 'Failed to migrate mods to deprecated PAK type.', { err });
            }
        }
        return Promise.resolve();
    });
}
function prepareForModding(api, discovery) {
    return __awaiter(this, void 0, void 0, function* () {
        const pcbanks = path_1.default.join(discovery.path, 'GAMEDATA', 'PCBANKS');
        const ensureDir = (dir) => vortex_api_1.fs.ensureDirWritableAsync(path_1.default.join(discovery.path, dir));
        return Promise.all([ensureDir(modPath()), ensureDir(deprecatedModPath())])
            .then(() => vortex_api_1.fs.renameAsync(path_1.default.join(pcbanks, 'DISABLEMODS.TXT'), path_1.default.join(pcbanks, 'ENABLEMODS.TXT'))
            .catch(err => err.code === 'ENOENT' ? Promise.resolve() : Promise.reject(err)));
    });
}
function requiresLauncher(gamePath, store) {
    return __awaiter(this, void 0, void 0, function* () {
        if (store === 'xbox') {
            return Promise.resolve({
                launcher: 'xbox',
                addInfo: {
                    appId: XBOX_ID,
                    parameters: [{ appExecName: 'NoMansSky' }],
                },
            });
        }
        else {
            return Promise.resolve(undefined);
        }
    });
}
function getPakPath(api, game) {
    const discovery = api.getState().settings.gameMode.discovered[game.id];
    if (!discovery || !discovery.path) {
        return '.';
    }
    const dataPath = path_1.default.join(discovery.path, deprecatedModPath());
    return dataPath;
}
function testDeprecatedPakMod(instructions) {
    return __awaiter(this, void 0, void 0, function* () {
        const hasPak = instructions.some(inst => inst.source && inst.source.match(/\.pak$/i));
        return Promise.resolve(hasPak);
    });
}
function getGameVersion(gamePath) {
    return __awaiter(this, void 0, void 0, function* () {
        const exeVersion = require('exe-version');
        return Promise.resolve(exeVersion.getProductVersionLocalized(path_1.default.join(gamePath, 'Binaries', 'NMS.exe')));
    });
}
function main(context) {
    context.registerGame({
        id: GAME_ID,
        name: 'No Man\'s Sky',
        mergeMods: true,
        queryPath: findGame,
        getGameVersion,
        queryModPath: modPath,
        logo: 'gameart.jpg',
        executable: () => 'Binaries/NMS.exe',
        requiredFiles: [
            'Binaries/NMS.exe',
        ],
        requiresLauncher: requiresLauncher,
        setup: (discovery) => prepareForModding(context.api, discovery),
        environment: {
            SteamAPPId: STEAMAPP_ID,
        },
        details: {
            steamAppId: +STEAMAPP_ID,
        },
    });
    context.registerModType(MODTYPE_DEPRECATED_PAK, 100, (gameId) => GAME_ID === gameId, (game) => getPakPath(context.api, game), testDeprecatedPakMod, { deploymentEssential: false, name: 'Deprecated PAK' });
    context.registerMigration(old => migrate101(context.api, old));
    return true;
}
module.exports = {
    default: main,
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUNBLGdEQUF3QjtBQUN4QixvREFBNEI7QUFDNUIsMkNBQTJEO0FBRTNELE1BQU0sT0FBTyxHQUFHLFdBQVcsQ0FBQztBQUM1QixNQUFNLFdBQVcsR0FBRyxRQUFRLENBQUM7QUFDN0IsTUFBTSxPQUFPLEdBQUcsc0JBQXNCLENBQUM7QUFDdkMsTUFBTSxzQkFBc0IsR0FBRywwQkFBMEIsQ0FBQztBQUUxRCxTQUFlLEtBQUssQ0FBQyxHQUF3Qjs7UUFDM0MsT0FBTyxJQUFJLE9BQU8sQ0FBTyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRSxDQUMzQyxHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsSUFBSSxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ2pGLENBQUM7Q0FBQTtBQUVELFNBQWUsTUFBTSxDQUFDLEdBQXdCOztRQUM1QyxPQUFPLElBQUksT0FBTyxDQUFPLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFLENBQzNDLEdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQztJQUM1RSxDQUFDO0NBQUE7QUFFRCxTQUFTLFFBQVE7SUFDZixPQUFPLGlCQUFJLENBQUMsZUFBZSxDQUFDLFdBQVcsQ0FBQyxDQUFDLFdBQVcsRUFBRSxPQUFPLENBQUMsQ0FBQztTQUM1RCxJQUFJLENBQUMsSUFBSSxDQUFDLEVB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LENBQUMsQ0FBQztJQUVILE9BQU8sQ0FBQyxlQUFlLENBQ3JCLHNCQUFzQixFQUN0QixHQUFHLEVBQ0gsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLE9BQU8sS0FBSyxNQUFNLEVBQzlCLENBQUMsSUFBaUIsRUFBRSxFQUFFLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQ3BELG9CQUEyQixFQUMzQixFQUFFLG1CQUFtQixFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsZ0JBQWdCLEVBQUUsQ0FDdkQsQ0FBQztJQUVGLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBUSxDQUFDLENBQUM7SUFFdEUsT0FBTyxJQUFJLENBQUM7QUFDZCxDQUFDO0FBRUQsTUFBTSxDQUFDLE9BQU8sR0FBRztJQUNmLE9BQU8sRUFBRSxJQUFJO0NBQ2QsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlICovXG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBzZW12ZXIgZnJvbSAnc2VtdmVyJztcbmltcG9ydCB7IGFjdGlvbnMsIGZzLCBsb2csIHR5cGVzLCB1dGlsIH0gZnJvbSAndm9ydGV4LWFwaSc7XG5cbmNvbnN0IEdBTUVfSUQgPSAnbm9tYW5zc2t5JztcbmNvbnN0IFNURUFNQVBQX0lEID0gJzI3NTg1MCc7XG5jb25zdCBYQk9YX0lEID0gJ0hlbGxvR2FtZXMuTm9NYW5zU2t5JztcbmNvbnN0IE1PRFRZUEVfREVQUkVDQVRFRF9QQUsgPSAnbm9tYW5zc2t5LWRlcHJlY2F0ZWQtcGFrJztcblxuYXN5bmMgZnVuY3Rpb24gcHVyZ2UoYXBpOiB0eXBlcy5JRXh0ZW5zaW9uQXBpKTogUHJvbWlzZTx2b2lkPiB7XG4gIHJldHVybiBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZSwgcmVqZWN0KSA9PlxuICAgIGFwaS5ldmVudHMuZW1pdCgncHVyZ2UtbW9kcycsIHRydWUsIChlcnIpID0+IGVyciA/IHJlamVjdChlcnIpIDogcmVzb2x2ZSgpKSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGRlcGxveShhcGk6IHR5cGVzLklFeHRlbnNpb25BcGkpOiBQcm9taXNlPHZvaWQ+IHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlLCByZWplY3QpID0+XG4gICAgYXBpLmV2ZW50cy5lbWl0KCdkZXBsb3ktbW9kcycsIChlcnIpID0+IGVyciA/IHJlamVjdChlcnIpIDogcmVzb2x2ZSgpKSk7XG59XG5cbmZ1bmN0aW9uIGZpbmRHYW1lKCkge1xuICByZXR1cm4gdXRpbC5HYW1lU3RvcmVIZWxwZXIuZmluZEJ5QXBwSWQoW1NURUFNQVBQX0lELCBYQk9YX0lEXSlcbiAgICAudGhlbihnYW1lID0+IGdhbWUuZ2FtZVBhdGgpO1xufVxuXG5mdW5jdGlvbiBkZXByZWNhdGVkTW9kUGF0aCgpIHtcbiAgcmV0dXJuIHBhdGguam9pbignR0FNRURBVEEnLCAnUENCQU5LUycsICdNT0RTJyk7XG59XG5cbmZ1bmN0aW9uIG1vZFBhdGgoKSB7XG4gIHJldHVybiBwYXRoLmpvaW4oJ0dBTUVEQVRBJywgJ01PRFMnKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gbWlncmF0ZTEwMShhcGk6IHR5cGVzLklFeHRlbnNpb25BcGksIG9sZFZlcnNpb246IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICBpZiAoc2VtdmVyLmd0ZShvbGRWZXJzaW9uLCAnMS4wLjEnKSkge1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgfVxuXG4gIGNvbnN0IHN0YXRlID0gYXBpLmdldFN0YXRlKCk7XG4gIGNvbnN0IG1vZHM6IHsgW21vZElkOiBzdHJpbmddOiB0eXBlcy5JTW9kIH0gPSB1dGlsLmdldFNhZmUoc3RhdGUsIFsncGVyc2lzdGVudCcsICdtb2RzJywgR0FNRV9JRF0sIHt9KTtcbiAgY29uc3QgbW9kSWRzID0gT2JqZWN0LmtleXMobW9kcykuZmlsdGVyKG1vZElkID0+IG1vZHNbbW9kSWRdLnR5cGUgIT09ICdub21hbnNza3ktZGVwcmVjYXRlZC1wYWsnKTtcbiAgY29uc3QgYmF0Y2hlZCA9IG1vZElkcy5tYXAobW9kSWQgPT4gYWN0aW9ucy5zZXRNb2RUeXBlKEdBTUVfSUQsIG1vZElkLCBNT0RUWVBFX0RFUFJFQ0FURURfUEFLKSk7XG4gIGlmIChiYXRjaGVkLmxlbmd0aCA+IDApIHtcbiAgICB0cnkge1xuICAgICAgbG9nKCdpbmZvJywgJ01pZ3JhdGluZyBtb2RzIHRvIGRlcHJlY2F0ZWQgUEFLIHR5cGUuJywgeyBtb2RzOiBiYXRjaGVkLmxlbmd0aCB9KTtcbiAgICAgIGF3YWl0IGFwaS5hd2FpdFVJKCk7XG4gICAgICBhd2FpdCBwdXJnZShhcGkpO1xuICAgICAgdXRpbC5iYXRjaERpc3BhdGNoKGFwaS5zdG9yZSwgYmF0Y2hlZCk7XG4gICAgICAvLyBIYWNreSBidXQgbmVjZXNzYXJ5IHRvIGVuc3VyZSB3ZSB3YWl0IGZvciB0aGUgc3RhdGUgdG8gdXBkYXRlLlxuICAgICAgYXdhaXQgbmV3IFByb21pc2U8dm9pZD4ocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDEwMDApKTtcbiAgICAgIGF3YWl0IGRlcGxveShhcGkpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nKCdlcnJvcicsICdGYWlsZWQgdG8gbWlncmF0ZSBtb2RzIHRvIGRlcHJlY2F0ZWQgUEFLIHR5cGUuJywgeyBlcnIgfSk7XG4gICAgfVxuICB9XG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcHJlcGFyZUZvck1vZGRpbmcoYXBpOiB0eXBlcy5JRXh0ZW5zaW9uQXBpLCBkaXNjb3Zlcnk6IHR5cGVzLklEaXNjb3ZlcnlSZXN1bHQpIHtcbiAgY29uc3QgcGNiYW5rcyA9IHBhdGguam9pbihkaXNjb3ZlcnkucGF0aCwgJ0dBTUVEQVRBJywgJ1BDQkFOS1MnKTtcbiAgY29uc3QgZW5zdXJlRGlyID0gKGRpcjogc3RyaW5nKSA9PiBmcy5lbnN1cmVEaXJXcml0YWJsZUFzeW5jKHBhdGguam9pbihkaXNjb3ZlcnkucGF0aCwgZGlyKSk7XG4gIHJldHVybiBQcm9taXNlLmFsbChbZW5zdXJlRGlyKG1vZFBhdGgoKSksIGVuc3VyZURpcihkZXByZWNhdGVkTW9kUGF0aCgpKV0pXG4gICAgLnRoZW4oKCkgPT4gZnMucmVuYW1lQXN5bmMocGF0aC5qb2luKHBjYmFua3MsICdESVNBQkxFTU9EUy5UWFQnKSwgcGF0aC5qb2luKHBjYmFua3MsICdFTkFCTEVNT0RTLlRYVCcpKVxuICAgICAgLmNhdGNoKGVyciA9PiBlcnIuY29kZSA9PT0gJ0VOT0VOVCcgPyBQcm9taXNlLnJlc29sdmUoKSA6IFByb21pc2UucmVqZWN0KGVycikpKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcmVxdWlyZXNMYXVuY2hlcihnYW1lUGF0aDogc3RyaW5nLCBzdG9yZT86IHN0cmluZykge1xuICBpZiAoc3RvcmUgPT09ICd4Ym94Jykge1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe1xuICAgICAgbGF1bmNoZXI6ICd4Ym94JyxcbiAgICAgIGFkZEluZm86IHtcbiAgICAgICAgYXBwSWQ6IFhCT1hfSUQsXG4gICAgICAgIHBhcmFtZXRlcnM6IFt7IGFwcEV4ZWNOYW1lOiAnTm9NYW5zU2t5JyB9XSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh1bmRlZmluZWQpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGdldFBha1BhdGgoYXBpOiB0eXBlcy5JRXh0ZW5zaW9uQXBpLCBnYW1lOiB0eXBlcy5JR2FtZSkge1xuICBjb25zdCBkaXNjb3ZlcnkgPSBhcGkuZ2V0U3RhdGUoKS5zZXR0aW5ncy5nYW1lTW9kZS5kaXNjb3ZlcmVkW2dhbWUuaWRdO1xuICBpZiAoIWRpc2NvdmVyeSB8fCAhZGlzY292ZXJ5LnBhdGgpIHtcbiAgICByZXR1cm4gJy4nO1xuICB9XG4gIGNvbnN0IGRhdGFQYXRoID0gcGF0aC5qb2luKGRpc2NvdmVyeS5wYXRoLCBkZXByZWNhdGVkTW9kUGF0aCgpKTtcbiAgcmV0dXJuIGRhdGFQYXRoO1xufVxuXG5hc3luYyBmdW5jdGlvbiB0ZXN0RGVwcmVjYXRlZFBha01vZChpbnN0cnVjdGlvbnM6IHR5cGVzLklJbnN0cnVjdGlvbltdKTogUHJvbWlzZTxib29sZWFuPiB7XG4gIGNvbnN0IGhhc1BhayA9IGluc3RydWN0aW9ucy5zb21lKGluc3QgPT4gaW5zdC5zb3VyY2UgJiYgaW5zdC5zb3VyY2UubWF0Y2goL1xcLnBhayQvaSkpO1xuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGhhc1Bhayk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEdhbWVWZXJzaW9uKGdhbWVQYXRoOiBzdHJpbmcpIHtcbiAgY29uc3QgZXhlVmVyc2lvbiA9IHJlcXVpcmUoJ2V4ZS12ZXJzaW9uJyk7XG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUoZXhlVmVyc2lvbi5nZXRQcm9kdWN0VmVyc2lvbkxvY2FsaXplZChwYXRoLmpvaW4oZ2FtZVBhdGgsICdCaW5hcmllcycsICdOTVMuZXhlJykpKTtcbn1cblxuZnVuY3Rpb24gbWFpbihjb250ZXh0OiB0eXBlcy5JRXh0ZW5zaW9uQ29udGV4dCkge1xuICBjb250ZXh0LnJlZ2lzdGVyR2FtZSh7XG4gICAgaWQ6IEdBTUVfSUQsXG4gICAgbmFtZTogJ05vIE1hblxcJ3MgU2t5JyxcbiAgICBtZXJnZU1vZHM6IHRydWUsXG4gICAgcXVlcnlQYXRoOiBmaW5kR2FtZSxcbiAgICBnZXRHYW1lVmVyc2lvbixcbiAgICBxdWVyeU1vZFBhdGg6IG1vZFBhdGgsXG4gICAgbG9nbzogJ2dhbWVhcnQuanBnJyxcbiAgICBleGVjdXRhYmxlOiAoKSA9PiAnQmluYXJpZXMvTk1TLmV4ZScsXG4gICAgcmVxdWlyZWRGaWxlczogW1xuICAgICAgJ0JpbmFyaWVzL05NUy5leGUnLFxuICAgIF0sXG4gICAgcmVxdWlyZXNMYXVuY2hlcjogcmVxdWlyZXNMYXVuY2hlciBhcyBhbnksXG4gICAgc2V0dXA6IChkaXNjb3Zlcnk6IHR5cGVzLklEaXNjb3ZlcnlSZXN1bHQpID0+IHByZXBhcmVGb3JNb2RkaW5nKGNvbnRleHQuYXBpLCBkaXNjb3ZlcnkpIGFzIGFueSxcbiAgICBlbnZpcm9ubWVudDoge1xuICAgICAgU3RlYW1BUFBJZDogU1RFQU1BUFBfSUQsXG4gICAgfSxcbiAgICBkZXRhaWxzOiB7XG4gICAgICBzdGVhbUFwcElkOiArU1RFQU1BUFBfSUQsXG4gICAgfSxcbiAgfSk7XG5cbiAgY29udGV4dC5yZWdpc3Rlck1vZFR5cGUoXG4gICAgTU9EVFlQRV9ERVBSRUNBVEVEX1BBSyxcbiAgICAxMDAsXG4gICAgKGdhbWVJZCkgPT4gR0FNRV9JRCA9PT0gZ2FtZUlkLFxuICAgIChnYW1lOiB0eXBlcy5JR2FtZSkgPT4gZ2V0UGFrUGF0aChjb250ZXh0LmFwaSwgZ2FtZSksXG4gICAgdGVzdERlcHJlY2F0ZWRQYWtNb2QgYXMgYW55LFxuICAgIHsgZGVwbG95bWVudEVzc2VudGlhbDogZmFsc2UsIG5hbWU6ICdEZXByZWNhdGVkIFBBSycgfVxuICApO1xuXG4gIGNvbnRleHQucmVnaXN0ZXJNaWdyYXRpb24ob2xkID0+IG1pZ3JhdGUxMDEoY29udGV4dC5hcGksIG9sZCkgYXMgYW55KTtcblxuICByZXR1cm4gdHJ1ZTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIGRlZmF1bHQ6IG1haW4sXG59O1xuIl19